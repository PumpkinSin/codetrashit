<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡é˜²å’Œè°å·¥å…·</title>
    <meta name="description" content="å¤„ç†å›¾ç‰‡ä»¥é˜²æ­¢å¹³å°è‡ªåŠ¨å®¡æ ¸ï¼Œä¿æŒäººçœ¼å¯è¯»æ€§çš„åŒæ—¶å¹²æ‰° OCR å’Œå›¾åƒè¯†åˆ«">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: rgba(255, 255, 255, 0.04);
            --bg-card-hover: rgba(255, 255, 255, 0.07);
            --border: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(255, 255, 255, 0.15);
            --text-primary: #e8e8ed;
            --text-secondary: #8888a0;
            --text-muted: #555568;
            --accent-1: #6c5ce7;
            --accent-2: #a855f7;
            --accent-3: #ec4899;
            --accent-gradient: linear-gradient(135deg, #6c5ce7, #a855f7, #ec4899);
            --accent-glow: rgba(108, 92, 231, 0.3);
            --success: #10b981;
            --radius: 16px;
            --radius-sm: 10px;
            --radius-xs: 6px;
            --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        html {
            font-size: 14px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -40%;
            left: -20%;
            width: 70%;
            height: 70%;
            background: radial-gradient(circle, rgba(108, 92, 231, 0.08) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            bottom: -30%;
            right: -10%;
            width: 60%;
            height: 60%;
            background: radial-gradient(circle, rgba(236, 72, 153, 0.06) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .app {
            position: relative;
            z-index: 1;
            max-width: 1440px;
            margin: 0 auto;
            padding: 20px 24px;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 20px;
            flex-wrap: wrap;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 14px;
            flex-shrink: 0;
        }

        header h1 {
            font-size: 1.6rem;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
            white-space: nowrap;
        }

        .header-subtitle {
            color: var(--text-muted);
            font-size: 0.72rem;
            font-weight: 300;
            line-height: 1.4;
            display: none;
        }

        /* Toolbar buttons */
        .toolbar {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .toolbar .btn {
            padding: 10px 22px;
            font-size: 0.88rem;
            border-radius: var(--radius-sm);
            white-space: nowrap;
        }

        .toolbar .btn-primary {
            padding: 12px 28px;
            font-size: 0.95rem;
        }

        .btn-copy {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #fff;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.25);
            display: none;
        }

        .btn-copy.show {
            display: flex;
        }

        .btn-copy:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 24px rgba(59, 130, 246, 0.4);
        }

        .toolbar-separator {
            width: 1px;
            height: 28px;
            background: var(--border);
            margin: 0 4px;
        }

        .toolbar .format-select {
            padding: 8px 12px;
            border-radius: var(--radius-xs);
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            outline: none;
        }

        .toolbar .format-select:focus {
            border-color: var(--accent-1);
        }

        @media (max-width: 900px) {
            header {
                flex-direction: column;
                align-items: flex-start;
            }

            .toolbar {
                width: 100%;
            }
        }

        .main-layout {
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 20px;
            align-items: start;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            transition: border-color var(--transition);
        }

        .card:hover {
            border-color: var(--border-hover);
        }

        .card-title {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--text-secondary);
            padding: 14px 18px 10px;
            border-bottom: 1px solid var(--border);
        }

        /* Upload */
        .upload-zone {
            padding: 16px;
        }

        .drop-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius-sm);
            padding: 32px 16px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition);
            position: relative;
            overflow: hidden;
        }

        .drop-area::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--accent-gradient);
            opacity: 0;
            transition: opacity var(--transition);
        }

        .drop-area:hover,
        .drop-area.drag-over {
            border-color: var(--accent-2);
        }

        .drop-area:hover::before,
        .drop-area.drag-over::before {
            opacity: 0.05;
        }

        .drop-area .icon {
            font-size: 2.4rem;
            margin-bottom: 8px;
            display: block;
        }

        .drop-area .label {
            font-size: 0.9rem;
            font-weight: 500;
            position: relative;
        }

        .drop-area .hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
            position: relative;
        }

        .file-info {
            margin-top: 12px;
            padding: 8px 12px;
            background: rgba(16, 185, 129, 0.08);
            border: 1px solid rgba(16, 185, 129, 0.15);
            border-radius: var(--radius-xs);
            font-size: 0.78rem;
            color: var(--success);
            display: none;
            align-items: center;
            gap: 6px;
        }

        .file-info.show {
            display: flex;
        }

        .file-info .name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Algo Items */
        .controls-panel {
            padding: 4px 0;
            max-height: 420px;
            overflow-y: auto;
        }

        .algo-item {
            padding: 10px 18px;
            border-bottom: 1px solid var(--border);
            transition: background var(--transition);
        }

        .algo-item:last-child {
            border-bottom: none;
        }

        .algo-item:hover {
            background: var(--bg-card-hover);
        }

        .algo-header {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }

        .algo-header .emoji {
            font-size: 1rem;
            flex-shrink: 0;
        }

        .algo-header .name {
            flex: 1;
            font-size: 0.82rem;
            font-weight: 500;
        }

        .algo-header .desc {
            display: none;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .toggle {
            position: relative;
            width: 36px;
            height: 18px;
            flex-shrink: 0;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
            position: absolute;
        }

        .toggle .slider {
            position: absolute;
            inset: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            transition: all var(--transition);
        }

        .toggle .slider::before {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            left: 2px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--text-muted);
            border-radius: 50%;
            transition: all var(--transition);
        }

        .toggle input:checked+.slider {
            background: var(--accent-1);
            border-color: var(--accent-1);
        }

        .toggle input:checked+.slider::before {
            transform: translateY(-50%) translateX(18px);
            background: #fff;
        }

        .algo-slider {
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            overflow: hidden;
            max-height: 0;
            transition: all 0.3s ease;
        }

        .algo-item.active .algo-slider {
            max-height: 36px;
            margin-top: 8px;
        }

        .algo-slider input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 3px;
            background: var(--border);
            border-radius: 3px;
            outline: none;
        }

        .algo-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--accent-gradient);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 6px var(--accent-glow);
        }

        .algo-slider .value {
            font-size: 0.72rem;
            color: var(--accent-2);
            font-weight: 600;
            min-width: 24px;
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        /* Presets */
        .preset-group {
            padding: 10px 18px;
            border-bottom: 1px solid var(--border);
        }

        .preset-group .label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 500;
        }

        .preset-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.72rem;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
            font-family: inherit;
            transition: all var(--transition);
        }

        .preset-btn:hover {
            border-color: var(--accent-2);
            color: var(--accent-2);
        }

        .preset-btn.active {
            border-color: var(--accent-1);
            background: rgba(108, 92, 231, 0.15);
            color: var(--accent-2);
        }

        /* Actions */
        .quality-group {
            padding: 12px 18px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quality-group .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
            white-space: nowrap;
        }

        .quality-group select {
            flex: 1;
            padding: 5px 8px;
            border-radius: var(--radius-xs);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.78rem;
            cursor: pointer;
            outline: none;
        }

        .quality-group select:focus {
            border-color: var(--accent-1);
        }

        .actions {
            padding: 12px 18px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 11px 16px;
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            border: none;
            transition: all var(--transition);
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--accent-gradient);
            color: #fff;
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 28px rgba(108, 92, 231, 0.45);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--border-hover);
            color: var(--text-primary);
        }

        .btn-download {
            background: linear-gradient(135deg, #10b981, #059669);
            color: #fff;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.25);
            display: none;
        }

        .btn-download.show {
            display: flex;
        }

        .btn-download:hover {
            transform: translateY(-1px);
        }

        /* Preview */
        .preview-area {
            min-height: 520px;
            display: flex;
            flex-direction: column;
        }

        .preview-header {
            padding: 10px 18px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .preview-tabs {
            display: flex;
            gap: 2px;
            background: var(--bg-secondary);
            border-radius: var(--radius-xs);
            padding: 2px;
        }

        .preview-tab {
            padding: 5px 14px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 4px;
            color: var(--text-secondary);
            transition: all var(--transition);
            border: none;
            background: none;
            font-family: inherit;
        }

        .preview-tab.active {
            background: var(--accent-1);
            color: #fff;
        }

        .preview-tab:hover:not(.active) {
            color: var(--text-primary);
        }

        .preview-body {
            flex: 1;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .empty-state {
            text-align: center;
            color: var(--text-muted);
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 10px;
            display: block;
            opacity: 0.5;
        }

        .empty-state .text {
            font-size: 0.88rem;
        }

        /* Comparison */
        .comparison-container {
            position: relative;
            display: none;
            max-width: 100%;
            max-height: 100%;
            overflow: hidden;
            border-radius: var(--radius-sm);
            cursor: ew-resize;
            user-select: none;
        }

        .comparison-container.show {
            display: block;
        }

        .comparison-container img,
        .comparison-container canvas {
            display: block;
            max-width: 100%;
            max-height: 60vh;
            object-fit: contain;
        }

        .comparison-before,
        .comparison-after {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .comparison-before {
            z-index: 2;
            overflow: hidden;
        }

        .comparison-line {
            position: absolute;
            top: 0;
            width: 3px;
            height: 100%;
            background: var(--accent-gradient);
            z-index: 3;
            box-shadow: 0 0 12px var(--accent-glow);
        }

        .comparison-handle {
            position: absolute;
            top: 50%;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-gradient);
            transform: translate(-50%, -50%);
            z-index: 4;
            box-shadow: 0 0 16px var(--accent-glow);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            color: #fff;
        }

        .comparison-label {
            position: absolute;
            top: 10px;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.68rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            z-index: 5;
            pointer-events: none;
        }

        .label-before {
            left: 10px;
            background: rgba(0, 0, 0, 0.6);
            color: var(--text-secondary);
            backdrop-filter: blur(8px);
        }

        .label-after {
            right: 10px;
            background: rgba(108, 92, 231, 0.7);
            color: #fff;
            backdrop-filter: blur(8px);
        }

        .single-view {
            display: none;
            max-width: 100%;
            max-height: 60vh;
            border-radius: var(--radius-sm);
        }

        .single-view.show {
            display: block;
        }

        .processing-overlay {
            position: absolute;
            inset: 0;
            background: rgba(10, 10, 15, 0.85);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 14px;
            z-index: 10;
            border-radius: var(--radius);
        }

        .processing-overlay.show {
            display: flex;
        }

        .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-2);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .processing-text {
            font-size: 0.82rem;
            color: var(--text-secondary);
        }

        .toast {
            position: fixed;
            bottom: 28px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 10px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.82rem;
            z-index: 100;
            backdrop-filter: blur(10px);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* Tip box */
        .tip-box {
            margin: 10px 18px;
            padding: 10px 14px;
            background: rgba(245, 158, 11, 0.06);
            border: 1px solid rgba(245, 158, 11, 0.12);
            border-radius: var(--radius-xs);
            font-size: 0.72rem;
            color: #f59e0b;
            line-height: 1.5;
        }

        @media (max-width: 900px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .preview-area {
                min-height: 400px;
            }
        }

        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        /* Section divider inside card */
        .section-divider {
            padding: 8px 18px 4px;
            font-size: 0.68rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
        }
    </style>
</head>

<body>

    <div class="app">
        <header>
            <div class="header-left">
                <h1>ğŸ›¡ï¸ å›¾ç‰‡é˜²å’Œè°</h1>
            </div>
            <div class="toolbar">
                <button class="btn btn-primary" id="processBtn" disabled>âš¡ å¼€å§‹å¤„ç†</button>
                <button class="btn btn-copy" id="copyBtn">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
                <button class="btn btn-download" id="downloadBtn">ğŸ’¾ ä¸‹è½½</button>
                <div class="toolbar-separator"></div>
                <select class="format-select" id="outputFormat">
                    <option value="png">PNG</option>
                    <option value="jpeg" selected>JPEG</option>
                    <option value="webp">WebP</option>
                </select>
                <button class="btn btn-secondary" id="resetBtn">ğŸ”„ é‡ç½®</button>
            </div>
        </header>

        <div class="main-layout">
            <!-- Left Panel -->
            <div class="left-panel">
                <!-- Upload -->
                <div class="card" style="margin-bottom: 14px;">
                    <div class="upload-zone">
                        <div class="drop-area" id="dropArea">
                            <span class="icon">ğŸ“·</span>
                            <div class="label">æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ</div>
                            <div class="hint">æˆ–ç‚¹å‡»é€‰æ‹© / Ctrl+V ç²˜è´´ Â· PNG / JPG / WebP</div>
                        </div>
                        <input type="file" id="fileInput" accept="image/*" style="display:none">
                        <div class="file-info" id="fileInfo">
                            <span>âœ…</span>
                            <span class="name" id="fileName"></span>
                        </div>
                    </div>
                </div>

                <!-- Algorithms -->
                <div class="card" style="margin-bottom: 14px;">
                    <div class="card-title">å¤„ç†ç®—æ³•</div>

                    <div class="preset-group">
                        <div class="label">å¿«æ·é¢„è®¾</div>
                        <div class="preset-buttons">
                            <button class="preset-btn" data-preset="light">è½»åº¦</button>
                            <button class="preset-btn active" data-preset="recommended">æ¨è</button>
                            <button class="preset-btn" data-preset="strong">å¼ºåŠ›</button>
                            <button class="preset-btn" data-preset="extreme">æé™</button>
                        </div>
                    </div>

                    <div class="tip-box">
                        ğŸ’¡ QQ ä½¿ç”¨ å“ˆå¸ŒåŒ¹é… + OCR + AI ä¸‰é‡æ£€æµ‹ã€‚å»ºè®®è‡³å°‘å¼€å¯<b>è¾¹æ¡†</b>+<b>æ—‹è½¬</b>+<b>ç½‘æ ¼</b>æ¥åŒæ—¶å¯¹æŠ—ä¸‰ç§æ£€æµ‹ã€‚
                    </div>

                    <div class="controls-panel">
                        <!-- === Anti-Hash === -->
                        <div class="section-divider">ğŸ”’ ç ´åå“ˆå¸ŒåŒ¹é…</div>

                        <div class="algo-item active" data-algo="border">
                            <div class="algo-header">
                                <span class="emoji">ğŸ–¼ï¸</span>
                                <span class="name">æ·»åŠ è¾¹æ¡†</span>
                                <label class="toggle"><input type="checkbox" checked><span
                                        class="slider"></span></label>
                            </div>
                            <div class="algo-slider">
                                <input type="range" min="5" max="80" value="30">
                                <span class="value">30</span>
                            </div>
                        </div>

                        <div class="algo-item active" data-algo="colorTint">
                            <div class="algo-header">
                                <span class="emoji">ğŸ¨</span>
                                <span class="name">è‰²å½©æ»¤é•œ</span>
                                <label class="toggle"><input type="checkbox" checked><span
                                        class="slider"></span></label>
                            </div>
                            <div class="algo-slider">
                                <input type="range" min="1" max="30" value="8">
                                <span class="value">8</span>
                            </div>
                        </div>

                        <div class="algo-item active" data-algo="rotate">
                            <div class="algo-header">
                                <span class="emoji">ğŸ”„</span>
                                <span class="name">è½»å¾®æ—‹è½¬</span>
                                <label class="toggle"><input type="checkbox" checked><span
                                        class="slider"></span></label>
                            </div>
                            <div class="algo-slider">
                                <input type="range" min="1" max="50" value="15">
                                <span class="value">1.5Â°</span>
                            </div>
                        </div>

                        <!-- === Anti-OCR === -->
                        <div class="section-divider">ğŸ” å¹²æ‰° OCR è¯†åˆ«</div>

                        <div class="algo-item active" data-algo="grid">
                            <div class="algo-header">
                                <span class="emoji">ğŸ“</span>
                                <span class="name">ç»†çº¿ç½‘æ ¼</span>
                                <label class="toggle"><input type="checkbox" checked><span
                                        class="slider"></span></label>
                            </div>
                            <div class="algo-slider">
                                <input type="range" min="10" max="200" value="40">
                                <span class="value">40</span>
                            </div>
                        </div>

                        <div class="algo-item active" data-algo="wave">
                            <div class="algo-header">
                                <span class="emoji">ğŸŒŠ</span>
                                <span class="name">æ³¢æµªå½¢å˜</span>
                                <label class="toggle"><input type="checkbox" checked><span
                                        class="slider"></span></label>
                            </div>
                            <div class="algo-slider">
                                <input type="range" min="1" max="15" value="4">
                                <span class="value">4</span>
                            </div>
                        </div>

                        <div class="algo-item active" data-algo="noise">
                            <div class="algo-header">
                                <span class="emoji">ğŸ”¹</span>
                                <span class="name">éšæœºå™ªç‚¹</span>
                                <label class="toggle"><input type="checkbox" checked><span
                                        class="slider"></span></label>
                            </div>
                            <div class="algo-slider">
                                <input type="range" min="1" max="60" value="20">
                                <span class="value">20</span>
                            </div>
                        </div>

                        <div class="algo-item active" data-algo="channel">
                            <div class="algo-header">
                                <span class="emoji">ğŸ”®</span>
                                <span class="name">é€šé“åç§»</span>
                                <label class="toggle"><input type="checkbox" checked><span
                                        class="slider"></span></label>
                            </div>
                            <div class="algo-slider">
                                <input type="range" min="1" max="8" value="2">
                                <span class="value">2</span>
                            </div>
                        </div>

                        <!-- === Anti-AI === -->
                        <div class="section-divider">ğŸ¤– å¯¹æŠ— AI åˆ†ç±»</div>

                        <div class="algo-item active" data-algo="dotMatrix">
                            <div class="algo-header">
                                <span class="emoji">âš¡</span>
                                <span class="name">ç‚¹é˜µå åŠ </span>
                                <label class="toggle"><input type="checkbox" checked><span
                                        class="slider"></span></label>
                            </div>
                            <div class="algo-slider">
                                <input type="range" min="2" max="20" value="6">
                                <span class="value">6</span>
                            </div>
                        </div>

                        <div class="algo-item" data-algo="pixelShift">
                            <div class="algo-header">
                                <span class="emoji">ğŸ”¸</span>
                                <span class="name">åƒç´ è¡Œåç§»</span>
                                <label class="toggle"><input type="checkbox"><span class="slider"></span></label>
                            </div>
                            <div class="algo-slider">
                                <input type="range" min="1" max="10" value="3">
                                <span class="value">3</span>
                            </div>
                        </div>

                        <div class="algo-item" data-algo="contrast">
                            <div class="algo-header">
                                <span class="emoji">ğŸŒ—</span>
                                <span class="name">å¯¹æ¯”åº¦æ³¢åŠ¨</span>
                                <label class="toggle"><input type="checkbox"><span class="slider"></span></label>
                            </div>
                            <div class="algo-slider">
                                <input type="range" min="1" max="20" value="5">
                                <span class="value">5</span>
                            </div>
                        </div>
                    </div>
                </div>


            </div>

            <!-- Right: Preview -->
            <div class="card preview-area">
                <div class="preview-header">
                    <div class="preview-tabs">
                        <button class="preview-tab active" data-view="compare">å¯¹æ¯”</button>
                        <button class="preview-tab" data-view="original">åŸå›¾</button>
                        <button class="preview-tab" data-view="processed">å¤„ç†å</button>
                    </div>
                </div>
                <div class="preview-body" id="previewBody">
                    <div class="empty-state" id="emptyState">
                        <span class="icon">ğŸ–¼ï¸</span>
                        <div class="text">ä¸Šä¼ å›¾ç‰‡å¼€å§‹å¤„ç†</div>
                    </div>
                    <div class="comparison-container" id="comparisonView">
                        <canvas id="afterCanvas"></canvas>
                        <div class="comparison-before" id="comparisonBefore">
                            <canvas id="beforeCanvas"></canvas>
                        </div>
                        <div class="comparison-line" id="comparisonLine"></div>
                        <div class="comparison-handle" id="comparisonHandle">â‡”</div>
                        <span class="comparison-label label-before">åŸå›¾</span>
                        <span class="comparison-label label-after">å¤„ç†å</span>
                    </div>
                    <canvas class="single-view" id="originalView"></canvas>
                    <canvas class="single-view" id="processedView"></canvas>
                    <div class="processing-overlay" id="processingOverlay">
                        <div class="spinner"></div>
                        <div class="processing-text">æ­£åœ¨å¤„ç†å›¾ç‰‡â€¦</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        (() => {
            'use strict';

            let originalImage = null;
            let processedImageData = null;
            let currentView = 'compare';

            const $ = id => document.getElementById(id);
            const dropArea = $('dropArea'), fileInput = $('fileInput');
            const fileInfo = $('fileInfo'), fileName = $('fileName');
            const processBtn = $('processBtn'), downloadBtn = $('downloadBtn'), resetBtn = $('resetBtn'), copyBtn = $('copyBtn');
            const emptyState = $('emptyState');
            const comparisonView = $('comparisonView'), comparisonBefore = $('comparisonBefore');
            const comparisonLine = $('comparisonLine'), comparisonHandle = $('comparisonHandle');
            const beforeCanvas = $('beforeCanvas'), afterCanvas = $('afterCanvas');
            const originalView = $('originalView'), processedView = $('processedView');
            const processingOverlay = $('processingOverlay');
            const outputFormat = $('outputFormat');
            const toast = $('toast');

            const algoItems = document.querySelectorAll('.algo-item');
            const presetBtns = document.querySelectorAll('.preset-btn');
            const previewTabs = document.querySelectorAll('.preview-tab');

            // preset: [enabled, value]
            const presets = {
                light: {
                    border: [true, 15], colorTint: [true, 5], rotate: [true, 8],
                    grid: [true, 100], wave: [false, 2], noise: [true, 10],
                    channel: [true, 1], dotMatrix: [false, 4], pixelShift: [false, 2], contrast: [false, 3]
                },
                recommended: {
                    border: [true, 30], colorTint: [true, 8], rotate: [true, 15],
                    grid: [true, 40], wave: [true, 4], noise: [true, 20],
                    channel: [true, 2], dotMatrix: [true, 6], pixelShift: [false, 3], contrast: [false, 5]
                },
                strong: {
                    border: [true, 50], colorTint: [true, 14], rotate: [true, 25],
                    grid: [true, 25], wave: [true, 7], noise: [true, 35],
                    channel: [true, 4], dotMatrix: [true, 10], pixelShift: [true, 4], contrast: [true, 8]
                },
                extreme: {
                    border: [true, 70], colorTint: [true, 20], rotate: [true, 40],
                    grid: [true, 15], wave: [true, 12], noise: [true, 50],
                    channel: [true, 6], dotMatrix: [true, 16], pixelShift: [true, 7], contrast: [true, 15]
                },
            };

            // === Upload ===
            dropArea.addEventListener('click', () => fileInput.click());
            dropArea.addEventListener('dragover', e => { e.preventDefault(); dropArea.classList.add('drag-over'); });
            dropArea.addEventListener('dragleave', () => dropArea.classList.remove('drag-over'));
            dropArea.addEventListener('drop', e => {
                e.preventDefault(); dropArea.classList.remove('drag-over');
                const f = e.dataTransfer.files[0];
                if (f && f.type.startsWith('image/')) loadFile(f);
            });
            fileInput.addEventListener('change', () => { if (fileInput.files[0]) loadFile(fileInput.files[0]); });
            document.addEventListener('paste', e => {
                const items = e.clipboardData?.items;
                if (!items) return;
                for (const it of items) {
                    if (it.type.startsWith('image/')) { loadFile(it.getAsFile()); break; }
                }
            });

            function loadFile(file) {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.onload = () => {
                        originalImage = img;
                        processedImageData = null;
                        fileName.textContent = `${file.name} (${img.width}Ã—${img.height})`;
                        fileInfo.classList.add('show');
                        processBtn.disabled = false;
                        downloadBtn.classList.remove('show');
                        showOriginalPreview();
                        showToast('å›¾ç‰‡å·²åŠ è½½');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            // === Algo toggles ===
            algoItems.forEach(item => {
                const toggle = item.querySelector('.toggle input');
                const slider = item.querySelector('input[type="range"]');
                const valueSpan = item.querySelector('.value');
                toggle.addEventListener('change', () => {
                    item.classList.toggle('active', toggle.checked);
                    presetBtns.forEach(b => b.classList.remove('active'));
                });
                slider.addEventListener('input', () => {
                    const algo = item.dataset.algo;
                    if (algo === 'rotate') {
                        valueSpan.textContent = (slider.value / 10).toFixed(1) + 'Â°';
                    } else {
                        valueSpan.textContent = slider.value;
                    }
                    presetBtns.forEach(b => b.classList.remove('active'));
                });
            });

            // === Presets ===
            presetBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const preset = presets[btn.dataset.preset];
                    if (!preset) return;
                    presetBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    algoItems.forEach(item => {
                        const algo = item.dataset.algo;
                        if (!preset[algo]) return;
                        const [enabled, value] = preset[algo];
                        const toggle = item.querySelector('.toggle input');
                        const slider = item.querySelector('input[type="range"]');
                        const valueSpan = item.querySelector('.value');
                        toggle.checked = enabled;
                        item.classList.toggle('active', enabled);
                        slider.value = value;
                        if (algo === 'rotate') {
                            valueSpan.textContent = (value / 10).toFixed(1) + 'Â°';
                        } else {
                            valueSpan.textContent = value;
                        }
                    });
                });
            });

            // === Preview tabs ===
            previewTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    previewTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentView = tab.dataset.view;
                    updatePreview();
                });
            });

            function showOriginalPreview() {
                if (!originalImage) return;
                emptyState.style.display = 'none';
                drawImageToCanvas(beforeCanvas, originalImage);
                afterCanvas.width = originalImage.width;
                afterCanvas.height = originalImage.height;
                afterCanvas.getContext('2d').drawImage(originalImage, 0, 0);
                drawImageToCanvas(originalView, originalImage);
                updatePreview();
            }

            function updatePreview() {
                comparisonView.classList.remove('show');
                originalView.classList.remove('show');
                processedView.classList.remove('show');
                if (!originalImage) return;
                if (currentView === 'compare') { comparisonView.classList.add('show'); resetComparisonSlider(); }
                else if (currentView === 'original') { drawImageToCanvas(originalView, originalImage); originalView.classList.add('show'); }
                else if (currentView === 'processed' && processedImageData) { processedView.classList.add('show'); }
            }

            function drawImageToCanvas(canvas, img) {
                canvas.width = img.width; canvas.height = img.height;
                canvas.getContext('2d').drawImage(img, 0, 0);
            }

            // === Comparison slider ===
            let isDragging = false;
            function resetComparisonSlider() { setSliderPos(0.5); }
            function setSliderPos(ratio) {
                const w = comparisonView.getBoundingClientRect().width;
                const x = ratio * w;
                comparisonBefore.style.width = x + 'px';
                comparisonLine.style.left = x + 'px';
                comparisonHandle.style.left = x + 'px';
            }
            comparisonView.addEventListener('pointerdown', e => { isDragging = true; comparisonView.setPointerCapture(e.pointerId); moveSlider(e); });
            comparisonView.addEventListener('pointermove', e => { if (isDragging) moveSlider(e); });
            comparisonView.addEventListener('pointerup', () => isDragging = false);
            function moveSlider(e) {
                const rect = comparisonView.getBoundingClientRect();
                let x = Math.max(0, Math.min(rect.width, e.clientX - rect.left));
                comparisonBefore.style.width = x + 'px';
                comparisonLine.style.left = x + 'px';
                comparisonHandle.style.left = x + 'px';
            }

            // === Processing ===
            processBtn.addEventListener('click', processImage);

            function getConfig() {
                const cfg = {};
                algoItems.forEach(item => {
                    cfg[item.dataset.algo] = {
                        on: item.querySelector('.toggle input').checked,
                        v: parseInt(item.querySelector('input[type="range"]').value, 10)
                    };
                });
                return cfg;
            }

            function processImage() {
                if (!originalImage) return;
                const cfg = getConfig();
                processingOverlay.classList.add('show');

                requestAnimationFrame(() => setTimeout(() => {
                    try {
                        // --- Step 1: Rotation (creates bigger canvas) ---
                        let w = originalImage.width, h = originalImage.height;
                        let canvas, ctx;

                        if (cfg.rotate?.on) {
                            const angle = (cfg.rotate.v / 10) * (Math.PI / 180);
                            // compute new canvas size to fit rotated image
                            const cos = Math.abs(Math.cos(angle)), sin = Math.abs(Math.sin(angle));
                            const nw = Math.ceil(w * cos + h * sin);
                            const nh = Math.ceil(w * sin + h * cos);
                            canvas = document.createElement('canvas');
                            canvas.width = nw; canvas.height = nh;
                            ctx = canvas.getContext('2d');
                            ctx.fillStyle = '#f0f0f0';
                            ctx.fillRect(0, 0, nw, nh);
                            ctx.save();
                            ctx.translate(nw / 2, nh / 2);
                            ctx.rotate(angle);
                            ctx.drawImage(originalImage, -w / 2, -h / 2);
                            ctx.restore();
                            w = nw; h = nh;
                        } else {
                            canvas = document.createElement('canvas');
                            canvas.width = w; canvas.height = h;
                            ctx = canvas.getContext('2d');
                            ctx.drawImage(originalImage, 0, 0);
                        }

                        // --- Step 2: Wave distortion ---
                        if (cfg.wave?.on) {
                            applyWave(ctx, canvas, cfg.wave.v);
                        }

                        // --- Step 3: Pixel-level processing ---
                        let imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                        if (cfg.noise?.on) applyNoise(imgData, cfg.noise.v);
                        if (cfg.channel?.on) imgData = applyChannelShift(imgData, cfg.channel.v);
                        if (cfg.pixelShift?.on) imgData = applyPixelShift(imgData, cfg.pixelShift.v);
                        if (cfg.contrast?.on) applyContrastWave(imgData, cfg.contrast.v);
                        if (cfg.colorTint?.on) applyColorTint(imgData, cfg.colorTint.v);

                        ctx.putImageData(imgData, 0, 0);

                        // --- Step 4: Overlay effects ---
                        if (cfg.grid?.on) applyGrid(ctx, canvas.width, canvas.height, cfg.grid.v);
                        if (cfg.dotMatrix?.on) applyDotMatrix(ctx, canvas.width, canvas.height, cfg.dotMatrix.v);

                        // --- Step 5: Border (LAST - wraps everything) ---
                        if (cfg.border?.on) {
                            canvas = applyBorder(canvas, cfg.border.v);
                            ctx = canvas.getContext('2d');
                        }

                        // Store
                        processedImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                        afterCanvas.width = canvas.width; afterCanvas.height = canvas.height;
                        afterCanvas.getContext('2d').putImageData(processedImageData, 0, 0);
                        processedView.width = canvas.width; processedView.height = canvas.height;
                        processedView.getContext('2d').putImageData(processedImageData, 0, 0);

                        downloadBtn.classList.add('show');
                        copyBtn.classList.add('show');
                        showToast('âœ… å¤„ç†å®Œæˆ');

                        previewTabs.forEach(t => t.classList.remove('active'));
                        document.querySelector('[data-view="compare"]').classList.add('active');
                        currentView = 'compare';
                        updatePreview();

                    } catch (err) {
                        console.error(err);
                        showToast('âŒ å¤„ç†å¤±è´¥ï¼š' + err.message);
                    } finally {
                        processingOverlay.classList.remove('show');
                    }
                }, 50));
            }

            // ===================================================================
            //  ALGORITHM IMPLEMENTATIONS
            // ===================================================================

            /** æ·»åŠ è¾¹æ¡† â€” æ”¹å˜å›¾ç‰‡å°ºå¯¸å’Œå“ˆå¸Œ */
            function applyBorder(srcCanvas, thickness) {
                const bw = thickness;
                const nw = srcCanvas.width + bw * 2;
                const nh = srcCanvas.height + bw * 2;
                const c = document.createElement('canvas');
                c.width = nw; c.height = nh;
                const cx = c.getContext('2d');

                // Gradient border
                const grad = cx.createLinearGradient(0, 0, nw, nh);
                grad.addColorStop(0, '#1a1a2e');
                grad.addColorStop(0.3, '#16213e');
                grad.addColorStop(0.6, '#0f3460');
                grad.addColorStop(1, '#1a1a2e');
                cx.fillStyle = grad;
                cx.fillRect(0, 0, nw, nh);

                // Add subtle noise to border to make each output unique
                const borderData = cx.getImageData(0, 0, nw, nh);
                const bd = borderData.data;
                for (let i = 0; i < bd.length; i += 4) {
                    const n = (Math.random() - 0.5) * 15;
                    bd[i] = clamp(bd[i] + n);
                    bd[i + 1] = clamp(bd[i + 1] + n);
                    bd[i + 2] = clamp(bd[i + 2] + n);
                }
                cx.putImageData(borderData, 0, 0);

                // Draw source image centered
                cx.drawImage(srcCanvas, bw, bw);

                // Inner shadow for depth
                cx.save();
                cx.globalAlpha = 0.3;
                cx.shadowColor = 'rgba(0,0,0,0.8)';
                cx.shadowBlur = 8;
                cx.shadowOffsetX = 0; cx.shadowOffsetY = 0;
                cx.strokeStyle = 'rgba(0,0,0,0.5)';
                cx.lineWidth = 1;
                cx.strokeRect(bw, bw, srcCanvas.width, srcCanvas.height);
                cx.restore();

                return c;
            }

            /** è‰²å½©æ»¤é•œ â€” æ•´ä½“åè‰²ï¼Œæ”¹å˜å›¾ç‰‡å“ˆå¸Œ */
            function applyColorTint(imgData, intensity) {
                const d = imgData.data;
                // Random hue tint
                const hueShift = Math.random() * 360;
                const r = Math.cos(hueShift * Math.PI / 180) * intensity;
                const g = Math.cos((hueShift + 120) * Math.PI / 180) * intensity;
                const b = Math.cos((hueShift + 240) * Math.PI / 180) * intensity;
                for (let i = 0; i < d.length; i += 4) {
                    d[i] = clamp(d[i] + r);
                    d[i + 1] = clamp(d[i + 1] + g);
                    d[i + 2] = clamp(d[i + 2] + b);
                }
            }

            /** ç½‘æ ¼åˆ‡å‰²çº¿ â€” çœŸæ­£å¯è§çš„ç»†çº¿ç½‘æ ¼ï¼Œç›´æ¥ç©¿è¿‡æ–‡å­—åŒºåŸŸç ´å OCR */
            function applyGrid(ctx, w, h, spacing) {
                ctx.save();

                // === Layer 1: ä¸»ç½‘æ ¼ â€” é«˜å¯è§åº¦ï¼Œç›´æ¥åˆ‡å‰²æ–‡å­— ===
                // é‡‡æ ·å›¾ç‰‡å¹³å‡äº®åº¦æ¥å†³å®šçº¿æ¡é¢œè‰²ï¼ˆæµ…åº•ç”¨æ·±çº¿ï¼Œæ·±åº•ç”¨æµ…çº¿ï¼‰
                const sample = ctx.getImageData(0, 0, Math.min(w, 100), Math.min(h, 100));
                const sd = sample.data;
                let totalBright = 0;
                for (let i = 0; i < sd.length; i += 16) {
                    totalBright += (sd[i] + sd[i + 1] + sd[i + 2]) / 3;
                }
                const avgBright = totalBright / (sd.length / 16);
                const isDark = avgBright < 128;

                // çº¿æ¡é¢œè‰²è‡ªé€‚åº”ï¼šæ·±è‰²èƒŒæ™¯ç”¨æµ…ç°çº¿ï¼Œæµ…è‰²èƒŒæ™¯ç”¨æ·±ç°çº¿
                const lineColor = isDark ? 'rgba(200, 200, 210, 0.35)' : 'rgba(80, 80, 90, 0.30)';
                const lineColor2 = isDark ? 'rgba(180, 180, 200, 0.20)' : 'rgba(100, 100, 110, 0.18)';

                ctx.lineWidth = 1;

                // ä¸»æ¨ªçº¿ â€” æ¯éš” spacing åƒç´ ä¸€æ ¹
                ctx.strokeStyle = lineColor;
                for (let y = spacing; y < h; y += spacing) {
                    const jitter = (Math.random() - 0.5) * 2;
                    ctx.beginPath();
                    ctx.moveTo(0, y + jitter);
                    ctx.lineTo(w, y + jitter);
                    ctx.stroke();
                }

                // ä¸»ç«–çº¿
                for (let x = spacing; x < w; x += spacing) {
                    const jitter = (Math.random() - 0.5) * 2;
                    ctx.beginPath();
                    ctx.moveTo(x + jitter, 0);
                    ctx.lineTo(x + jitter, h);
                    ctx.stroke();
                }

                // === Layer 2: ä¸­é—´å¯†åº¦çš„è¾…åŠ©çº¿ï¼ˆé—´è·å‡åŠï¼Œç¨ä½é€æ˜åº¦ï¼‰===
                ctx.strokeStyle = lineColor2;
                ctx.lineWidth = 0.5;
                const halfSpacing = spacing / 2;
                for (let y = halfSpacing; y < h; y += spacing) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(w, y);
                    ctx.stroke();
                }
                for (let x = halfSpacing; x < w; x += spacing) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, h);
                    ctx.stroke();
                }

                // === Layer 3: æ–œçº¿äº¤å‰ â€” è¿›ä¸€æ­¥æ‰“ç¢è¿é€šåŸŸ ===
                const diagColor = isDark ? 'rgba(170, 170, 190, 0.12)' : 'rgba(90, 90, 100, 0.10)';
                ctx.strokeStyle = diagColor;
                ctx.lineWidth = 0.8;
                const diagSpacing = spacing * 1.5;

                // 45Â° æ–œçº¿
                for (let d = -Math.max(w, h); d < Math.max(w, h) * 2; d += diagSpacing) {
                    ctx.beginPath();
                    ctx.moveTo(d, 0);
                    ctx.lineTo(d + h, h);
                    ctx.stroke();
                }
                // 135Â° æ–œçº¿
                for (let d = -Math.max(w, h); d < Math.max(w, h) * 2; d += diagSpacing) {
                    ctx.beginPath();
                    ctx.moveTo(d, h);
                    ctx.lineTo(d + h, 0);
                    ctx.stroke();
                }

                // === Layer 4: éšæœºçŸ­çº¿æ®µç©¿æ’ â€” å¢åŠ æ··ä¹±åº¦ ===
                const shortLineColor = isDark ? 'rgba(190, 190, 210, 0.25)' : 'rgba(70, 70, 80, 0.20)';
                ctx.strokeStyle = shortLineColor;
                ctx.lineWidth = 1;
                const shortCount = Math.floor((w * h) / (spacing * spacing) * 0.8);
                for (let i = 0; i < shortCount; i++) {
                    const x1 = Math.random() * w;
                    const y1 = Math.random() * h;
                    const len = 10 + Math.random() * spacing * 0.8;
                    const angle = (Math.floor(Math.random() * 4)) * Math.PI / 4; // 0Â°, 45Â°, 90Â°, 135Â°
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x1 + Math.cos(angle) * len, y1 + Math.sin(angle) * len);
                    ctx.stroke();
                }

                ctx.restore();
            }

            /** æ³¢æµªå½¢å˜ â€” éçº¿æ€§å‡ ä½•å˜æ¢ï¼Œå½»åº•ç ´åæ–‡å­—è¿ç»­æ€§ */
            function applyWave(ctx, canvas, amplitude) {
                const w = canvas.width, h = canvas.height;
                const src = ctx.getImageData(0, 0, w, h);
                const dst = ctx.createImageData(w, h);
                const sd = src.data, dd = dst.data;

                const freq = 2 * Math.PI / (h * 0.3);
                const freqX = 2 * Math.PI / (w * 0.4);

                for (let y = 0; y < h; y++) {
                    for (let x = 0; x < w; x++) {
                        // Horizontal wave based on y
                        const dx = Math.round(Math.sin(y * freq) * amplitude);
                        // Vertical wave based on x
                        const dy = Math.round(Math.sin(x * freqX) * amplitude * 0.5);

                        const sx = x - dx, sy = y - dy;
                        if (sx >= 0 && sx < w && sy >= 0 && sy < h) {
                            const si = (sy * w + sx) * 4;
                            const di = (y * w + x) * 4;
                            dd[di] = sd[si]; dd[di + 1] = sd[si + 1]; dd[di + 2] = sd[si + 2]; dd[di + 3] = sd[si + 3];
                        }
                    }
                }
                ctx.putImageData(dst, 0, 0);
            }

            /** éšæœºå™ªç‚¹ */
            function applyNoise(imgData, intensity) {
                const d = imgData.data;
                for (let i = 0; i < d.length; i += 4) {
                    d[i] = clamp(d[i] + (Math.random() - 0.5) * intensity * 2);
                    d[i + 1] = clamp(d[i + 1] + (Math.random() - 0.5) * intensity * 2);
                    d[i + 2] = clamp(d[i + 2] + (Math.random() - 0.5) * intensity * 2);
                }
            }

            /** é€šé“åç§» â€” R/B é€šé“ç©ºé—´ä½ç§» */
            function applyChannelShift(imgData, offset) {
                const { width: w, height: h, data: d } = imgData;
                const nd = new Uint8ClampedArray(d);
                for (let y = 0; y < h; y++) {
                    for (let x = 0; x < w; x++) {
                        const idx = (y * w + x) * 4;
                        // R right
                        const rx = x - offset;
                        if (rx >= 0 && rx < w) nd[idx] = d[(y * w + rx) * 4];
                        // B left
                        const bx = x + offset;
                        if (bx >= 0 && bx < w) nd[idx + 2] = d[(y * w + bx) * 4 + 2];
                    }
                }
                return new ImageData(nd, w, h);
            }

            /** åƒç´ è¡Œåç§» */
            function applyPixelShift(imgData, amount) {
                const { width: w, height: h, data: d } = imgData;
                const nd = new Uint8ClampedArray(d);
                const interval = Math.max(2, Math.floor(7 - amount));
                for (let y = 0; y < h; y++) {
                    if (y % interval !== 0) continue;
                    const shift = Math.round((Math.random() - 0.5) * amount * 2);
                    for (let x = 0; x < w; x++) {
                        const sx = x - shift;
                        if (sx >= 0 && sx < w) {
                            const di = (y * w + x) * 4, si = (y * w + sx) * 4;
                            nd[di] = d[si]; nd[di + 1] = d[si + 1]; nd[di + 2] = d[si + 2]; nd[di + 3] = d[si + 3];
                        }
                    }
                }
                return new ImageData(nd, w, h);
            }

            /** å¯¹æ¯”åº¦æ³¢åŠ¨ â€” æ­£å¼¦æ³¢çŠ¶å¯¹æ¯”åº¦å˜åŒ– */
            function applyContrastWave(imgData, intensity) {
                const { width: w, height: h, data: d } = imgData;
                const factor = intensity / 100;
                for (let y = 0; y < h; y++) {
                    // sinusoidal contrast multiplier
                    const contrast = 1 + Math.sin(y * Math.PI * 6 / h) * factor;
                    for (let x = 0; x < w; x++) {
                        const i = (y * w + x) * 4;
                        d[i] = clamp(128 + (d[i] - 128) * contrast);
                        d[i + 1] = clamp(128 + (d[i + 1] - 128) * contrast);
                        d[i + 2] = clamp(128 + (d[i + 2] - 128) * contrast);
                    }
                }
            }

            /** ç‚¹é˜µå åŠ  â€” åŠè°ƒé£æ ¼åœ†ç‚¹ï¼Œå¹²æ‰° AI ç‰¹å¾æå– */
            function applyDotMatrix(ctx, w, h, spacing) {
                ctx.save();
                const step = spacing;

                for (let y = 0; y < h; y += step) {
                    for (let x = 0; x < w; x += step) {
                        // Random tiny colored dots
                        const hue = Math.random() * 360;
                        const alpha = 0.03 + Math.random() * 0.04;
                        ctx.fillStyle = `hsla(${hue}, 40%, 50%, ${alpha})`;
                        const r = 0.5 + Math.random() * 1.5;
                        ctx.beginPath();
                        ctx.arc(x + Math.random() * step, y + Math.random() * step, r, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }

                // Also add some random larger semi-transparent shapes
                ctx.globalAlpha = 0.015;
                for (let i = 0; i < Math.floor(w * h / 50000); i++) {
                    const hue = Math.random() * 360;
                    ctx.fillStyle = `hsl(${hue}, 30%, 50%)`;
                    ctx.beginPath();
                    ctx.arc(Math.random() * w, Math.random() * h, 2 + Math.random() * 4, 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.restore();
            }

            function clamp(v) { return v < 0 ? 0 : v > 255 ? 255 : v; }

            // === Download ===
            downloadBtn.addEventListener('click', () => {
                if (!processedImageData) return;
                const c = document.createElement('canvas');
                c.width = processedImageData.width; c.height = processedImageData.height;
                c.getContext('2d').putImageData(processedImageData, 0, 0);
                const fmt = outputFormat.value;
                const mime = fmt === 'png' ? 'image/png' : fmt === 'webp' ? 'image/webp' : 'image/jpeg';
                const quality = fmt === 'png' ? undefined : 0.88;
                c.toBlob(blob => {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `anti-harmony_${Date.now()}.${fmt}`;
                    a.click();
                    URL.revokeObjectURL(a.href);
                    showToast('ğŸ’¾ å›¾ç‰‡å·²ä¿å­˜');
                }, mime, quality);
            });

            // === Copy to clipboard ===
            copyBtn.addEventListener('click', async () => {
                if (!processedImageData) return;
                try {
                    const c = document.createElement('canvas');
                    c.width = processedImageData.width;
                    c.height = processedImageData.height;
                    c.getContext('2d').putImageData(processedImageData, 0, 0);
                    const blob = await new Promise(resolve => c.toBlob(resolve, 'image/png'));
                    await navigator.clipboard.write([
                        new ClipboardItem({ 'image/png': blob })
                    ]);
                    showToast('ğŸ“‹ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå¯ç›´æ¥ç²˜è´´åˆ° QQ');
                } catch (err) {
                    console.error(err);
                    showToast('âŒ å¤åˆ¶å¤±è´¥ï¼š' + err.message);
                }
            });

            // === Reset ===
            resetBtn.addEventListener('click', () => {
                originalImage = null; processedImageData = null;
                fileInput.value = '';
                fileInfo.classList.remove('show');
                processBtn.disabled = true;
                downloadBtn.classList.remove('show');
                copyBtn.classList.remove('show');
                emptyState.style.display = '';
                comparisonView.classList.remove('show');
                originalView.classList.remove('show');
                processedView.classList.remove('show');
                showToast('å·²é‡ç½®');
            });

            // === Toast ===
            let toastTimer;
            function showToast(msg) {
                toast.textContent = msg;
                toast.classList.add('show');
                clearTimeout(toastTimer);
                toastTimer = setTimeout(() => toast.classList.remove('show'), 2500);
            }
        })();
    </script>
</body>

</html>